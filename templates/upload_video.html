{% extends "base.html" %}
{% block title %}ì˜ìƒ ì¶”ê°€{% endblock %}
{% block content %}

<section style="max-width: 800px; margin: 0 auto; padding: 40px 30px;">
    
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div style="text-align: center; margin-bottom: 40px;">
        <h1 style="font-size: 2.2em; color: #2c3e50; font-weight: 300; margin: 0;">ì˜ìƒ ì¶”ê°€</h1>
        <div style="width: 50px; height: 2px; background: #8b7355; margin: 20px auto;"></div>
        <p style="color: #666; font-size: 1em;">YouTube ë˜ëŠ” ë¡œì»¬ íŒŒì¼ë¡œ ì˜ìƒì„ ì¶”ê°€í•˜ì„¸ìš”</p>
    </div>

    <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
    <div style="margin-bottom: 30px;">
        <a href="/portfolio" 
           style="display: inline-flex; align-items: center; color: #8b7355; text-decoration: none; font-weight: 400; transition: all 0.3s ease;"
           onmouseover="this.style.color='#6d5a42'"
           onmouseout="this.style.color='#8b7355'">
            â† í¬íŠ¸í´ë¦¬ì˜¤ë¡œ ëŒì•„ê°€ê¸°
        </a>
    </div>

    <!-- í”Œë«í¼ ì„ íƒ íƒ­ -->
    <div style="background: #ffffff; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px; overflow: hidden;">
        <div style="display: flex; border-bottom: 1px solid #f0f0f0;">
            <button id="tab-youtube" class="platform-tab active" onclick="switchPlatform('youtube')" 
                    style="flex: 1; padding: 15px 20px; border: none; background: #ff0000; color: white; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">
                ğŸ“º YouTube
            </button>
            <button id="tab-local" class="platform-tab" onclick="switchPlatform('local')" 
                    style="flex: 1; padding: 15px 20px; border: none; background: #f8f9fa; color: #666; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">
                ğŸ’¾ ë¡œì»¬ íŒŒì¼
            </button>
        </div>
    </div>

    <!-- ì˜ìƒ ì¶”ê°€ í¼ -->
    <div style="background: #ffffff; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 40px;">
        <form method="POST" enctype="multipart/form-data" id="addVideoForm">
            <input type="hidden" id="platform" name="platform" value="youtube">
            
            <!-- YouTube ì„¹ì…˜ -->
            <div id="youtube-section" class="platform-section">
                <div style="margin-bottom: 30px;">
                    <label for="youtube_url" style="display: block; margin-bottom: 10px; font-weight: 500; color: #2c3e50;">YouTube URL *</label>
                    <input type="url" 
                           id="youtube_url" 
                           name="youtube_url" 
                           placeholder="https://www.youtube.com/watch?v=... ë˜ëŠ” https://youtu.be/..."
                           style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;"
                           onchange="extractYouTubeInfo()">
                    <div style="margin-top: 5px; color: #666; font-size: 0.9em;">
                        YouTube ì˜ìƒ URLì„ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ì œëª©ê³¼ ì¸ë„¤ì¼ì„ ê°€ì ¸ì˜µë‹ˆë‹¤
                    </div>
                </div>
                
                <!-- YouTube ë¯¸ë¦¬ë³´ê¸° -->
                <div id="youtube-preview" style="display: none; margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <div style="display: flex; gap: 20px; align-items: flex-start;">
                        <img id="youtube-thumbnail" style="width: 200px; height: 112px; object-fit: cover; border-radius: 8px;">
                        <div style="flex: 1;">
                            <h4 id="youtube-title" style="margin: 0 0 10px 0; color: #2c3e50;"></h4>
                            <p id="youtube-description" style="margin: 0; color: #666; font-size: 0.9em; line-height: 1.5;"></p>
                            <div style="margin-top: 10px; color: #999; font-size: 0.8em;">
                                <span id="youtube-duration"></span> â€¢ <span id="youtube-views"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ë¡œì»¬ íŒŒì¼ ì„¹ì…˜ -->
            <div id="local-section" class="platform-section" style="display: none;">
                <div style="margin-bottom: 30px;">
                    <label for="video_file" style="display: block; margin-bottom: 10px; font-weight: 500; color: #2c3e50;">ì˜ìƒ íŒŒì¼ *</label>
                    <div style="position: relative;">
                        <input type="file" 
                               id="video_file" 
                               name="video_file" 
                               accept="video/*"
                               style="display: none;"
                               onchange="handleVideoFileUpload(this)">
                        <div id="videoDropZone" 
                             style="border: 2px dashed #ddd; border-radius: 10px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s ease; background: #f8f9fa;"
                             onclick="document.getElementById('video_file').click()"
                             ondragover="handleDragOver(event)"
                             ondrop="handleDrop(event)">
                            <div id="videoUploadContent">
                                <div style="font-size: 3em; margin-bottom: 15px; opacity: 0.5;">ğŸ¬</div>
                                <p style="margin: 0 0 10px 0; color: #666; font-size: 1.1em;">ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                                <p style="margin: 0; color: #999; font-size: 0.9em;">ì§€ì› í˜•ì‹: MP4, WebM, AVI, MOV (ìµœëŒ€ 100MB)</p>
                                <p style="margin: 5px 0 0 0; color: #e74c3c; font-size: 0.8em;">âš ï¸ PythonAnywhere ìš©ëŸ‰ ì œí•œìœ¼ë¡œ ì¸í•´ ì‘ì€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ë¡œì»¬ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° -->
                    <div id="local-preview" style="display: none; margin-top: 20px;">
                        <video id="previewVideo" controls style="width: 100%; max-height: 300px; border-radius: 8px;"></video>
                        <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                            <span id="videoInfo" style="color: #666; font-size: 0.9em;"></span>
                            <button type="button" onclick="removeVideoFile()" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 0.8em; cursor: pointer;">
                                íŒŒì¼ ì œê±°
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ê³µí†µ ì…ë ¥ í•„ë“œë“¤ -->
            <div style="border-top: 1px solid #f0f0f0; padding-top: 30px; margin-top: 30px;">
                
                <!-- ì˜ìƒ ì œëª© -->
                <div style="margin-bottom: 25px;">
                    <label for="title" style="display: block; margin-bottom: 10px; font-weight: 500; color: #2c3e50;">ì˜ìƒ ì œëª© *</label>
                    <input type="text" 
                           id="title" 
                           name="title" 
                           required 
                           placeholder="ì˜ìƒ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                           style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
                </div>

                <!-- ì˜ìƒ ì„¤ëª… -->
                <div style="margin-bottom: 25px;">
                    <label for="description" style="display: block; margin-bottom: 10px; font-weight: 500; color: #2c3e50;">ì˜ìƒ ì„¤ëª…</label>
                    <textarea id="description" 
                              name="description" 
                              rows="5" 
                              placeholder="ì˜ìƒì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                              style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
                </div>

                <!-- ì—°ì£¼ì/ì‘ì„±ì -->
                <div style="margin-bottom: 25px;">
                    <label for="author" style="display: block; margin-bottom: 10px; font-weight: 500; color: #2c3e50;">ì—°ì£¼ì/ì‘ì„±ì</label>
                    <input type="text" 
                           id="author" 
                           name="author" 
                           value="ì•™ìƒë¸” ë‹¤ìœ¤"
                           placeholder="ì—°ì£¼ì ë˜ëŠ” ì‘ì„±ìëª…"
                           style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
                </div>

                <!-- ê³µì—° ë‚ ì§œ -->
                <div style="margin-bottom: 25px;">
                    <label for="performance_date" style="display: block; margin-bottom: 10px; font-weight: 500; color: #2c3e50;">ê³µì—° ë‚ ì§œ (ì„ íƒì‚¬í•­)</label>
                    <input type="date" 
                           id="performance_date" 
                           name="performance_date"
                           style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
                </div>

                <!-- íƒœê·¸ -->
                <div style="margin-bottom: 25px;">
                    <label for="tags" style="display: block; margin-bottom: 10px; font-weight: 500; color: #2c3e50;">íƒœê·¸ (ì„ íƒì‚¬í•­)</label>
                    <input type="text" 
                           id="tags" 
                           name="tags" 
                           placeholder="íƒœê·¸ë¥¼ ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: í´ë˜ì‹, ì‹¤ë‚´ì•…, ì½˜ì„œíŠ¸)"
                           style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
                    <div style="margin-top: 5px; color: #666; font-size: 0.9em;">
                        ê²€ìƒ‰ê³¼ ë¶„ë¥˜ë¥¼ ìœ„í•œ íƒœê·¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”
                    </div>
                </div>

                <!-- ì¸ë„¤ì¼ ì»¤ìŠ¤í„°ë§ˆì´ì§• (ì„ íƒì‚¬í•­) -->
                <div style="margin-bottom: 25px;">
                    <label for="custom_thumbnail" style="display: block; margin-bottom: 10px; font-weight: 500; color: #2c3e50;">ì»¤ìŠ¤í…€ ì¸ë„¤ì¼ (ì„ íƒì‚¬í•­)</label>
                    <input type="file" 
                           id="custom_thumbnail" 
                           name="custom_thumbnail" 
                           accept="image/*"
                           style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;"
                           onchange="previewThumbnail(this)">
                    <div style="margin-top: 5px; color: #666; font-size: 0.9em;">
                        ì—…ë¡œë“œí•˜ì§€ ì•Šìœ¼ë©´ í”Œë«í¼ì˜ ê¸°ë³¸ ì¸ë„¤ì¼ì„ ì‚¬ìš©í•©ë‹ˆë‹¤
                    </div>
                    
                    <!-- ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸° -->
                    <div id="thumbnail-preview" style="display: none; margin-top: 15px;">
                        <img id="preview-thumbnail" style="width: 200px; height: 112px; object-fit: cover; border-radius: 8px;">
                    </div>
                </div>
            </div>

            <!-- ë²„íŠ¼ë“¤ -->
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 40px; flex-wrap: wrap;">
                <button type="button" 
                        onclick="window.location.href='/portfolio'"
                        style="background: #f8f9fa; color: #666; padding: 12px 30px; border: 1px solid #ddd; border-radius: 25px; cursor: pointer; font-size: 1rem; transition: all 0.3s ease;"
                        onmouseover="this.style.background='#e9ecef'"
                        onmouseout="this.style.background='#f8f9fa'">
                    ì·¨ì†Œ
                </button>
                
                <button type="submit" 
                        id="submitBtn"
                        style="background: #8b7355; color: white; padding: 12px 30px; border: none; border-radius: 25px; cursor: pointer; font-size: 1rem; transition: all 0.3s ease;"
                        onmouseover="this.style.background='#6d5a42'"
                        onmouseout="this.style.background='#8b7355'">
                    ì˜ìƒ ì¶”ê°€
                </button>
            </div>
        </form>
    </div>
</section>

<style>
/* íƒ­ ìŠ¤íƒ€ì¼ */
.platform-tab.active {
    background: #8b7355 !important;
    color: white !important;
}

.platform-tab:hover:not(.active) {
    background: #e9ecef !important;
}

/* ë“œë˜ê·¸ ì•¤ ë“œë¡­ ìŠ¤íƒ€ì¼ */
.drag-over {
    border-color: #8b7355 !important;
    background-color: #f0f9ff !important;
}

/* ë°˜ì‘í˜• ë””ìì¸ */
@media (max-width: 768px) {
    section {
        padding: 20px 15px !important;
    }
    
    .platform-tabs {
        flex-direction: column !important;
    }
    
    .platform-tab {
        border-bottom: 1px solid #f0f0f0 !important;
    }
    
    .form-container {
        padding: 25px !important;
    }
    
    .button-group {
        flex-direction: column !important;
        gap: 10px !important;
    }
    
    .button-group button {
        width: 100% !important;
    }
    
    .preview-container {
        flex-direction: column !important;
    }
    
    .preview-container img {
        width: 100% !important;
        max-width: 300px;
    }
}
</style>

<script>
// í˜„ì¬ ì„ íƒëœ í”Œë«í¼
let currentPlatform = 'youtube';

// í”Œë«í¼ ì „í™˜
function switchPlatform(platform) {
    // íƒ­ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
    document.querySelectorAll('.platform-tab').forEach(tab => {
        tab.classList.remove('active');
        tab.style.background = '#f8f9fa';
        tab.style.color = '#666';
    });
    
    const activeTab = document.getElementById(`tab-${platform}`);
    activeTab.classList.add('active');
    
    if (platform === 'youtube') {
        activeTab.style.background = '#ff0000';
        activeTab.style.color = 'white';
    } else {
        activeTab.style.background = '#8b7355';
        activeTab.style.color = 'white';
    }
    
    // ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¸°ê¸°
    document.querySelectorAll('.platform-section').forEach(section => {
        section.style.display = 'none';
    });
    document.getElementById(`${platform}-section`).style.display = 'block';
    
    // ìˆ¨ê²¨ì§„ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
    document.getElementById('platform').value = platform;
    currentPlatform = platform;
    
    // í¼ ìœ íš¨ì„± ê²€ì‚¬ ì—…ë°ì´íŠ¸
    updateFormValidation();
}

// í¼ ìœ íš¨ì„± ê²€ì‚¬ ì—…ë°ì´íŠ¸
function updateFormValidation() {
    // ëª¨ë“  í”Œë«í¼ë³„ í•„ìˆ˜ ì…ë ¥ ì œê±°
    document.getElementById('youtube_url').required = false;
    document.getElementById('video_file').required = false;
    
    // í˜„ì¬ í”Œë«í¼ì˜ í•„ìˆ˜ ì…ë ¥ ì„¤ì •
    if (currentPlatform === 'youtube') {
        document.getElementById('youtube_url').required = true;
    } else if (currentPlatform === 'local') {
        document.getElementById('video_file').required = true;
    }
}

// YouTube ì •ë³´ ì¶”ì¶œ
async function extractYouTubeInfo() {
    const url = document.getElementById('youtube_url').value;
    if (!url) return;
    
    const videoId = extractYouTubeVideoId(url);
    if (!videoId) {
        alert('ì˜¬ë°”ë¥¸ YouTube URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    try {
        // YouTube API ë˜ëŠ” oEmbedë¥¼ ì‚¬ìš©í•˜ì—¬ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const response = await fetch(`https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`);
        const data = await response.json();
        
        // ì œëª© ìë™ ì…ë ¥
        document.getElementById('title').value = data.title;
        
        // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        document.getElementById('youtube-thumbnail').src = data.thumbnail_url;
        document.getElementById('youtube-title').textContent = data.title;
        document.getElementById('youtube-description').textContent = data.author_name + ' ì±„ë„';
        document.getElementById('youtube-preview').style.display = 'block';
        
    } catch (error) {
        console.error('YouTube ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
        // ê¸°ë³¸ ì¸ë„¤ì¼ë§Œ í‘œì‹œ
        const thumbnailUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
        document.getElementById('youtube-thumbnail').src = thumbnailUrl;
        document.getElementById('youtube-title').textContent = 'ì œëª©ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
        document.getElementById('youtube-description').textContent = '';
        document.getElementById('youtube-preview').style.display = 'block';
    }
}

// YouTube ë¹„ë””ì˜¤ ID ì¶”ì¶œ
function extractYouTubeVideoId(url) {
    const regex = /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/;
    const match = url.match(regex);
    return match ? match[1] : null;
}

// ë¡œì»¬ íŒŒì¼ ì²˜ë¦¬
function handleVideoFileUpload(input) {
    const file = input.files[0];
    if (!file) return;
    
    // íŒŒì¼ í¬ê¸° ê²€ì‚¬ (100MB ì œí•œ)
    const maxSize = 100 * 1024 * 1024;
    if (file.size > maxSize) {
        alert('íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. 100MB ì´í•˜ì˜ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        input.value = '';
        return;
    }
    
    // ì§€ì›ë˜ëŠ” í˜•ì‹ ê²€ì‚¬
    const supportedTypes = ['video/mp4', 'video/webm', 'video/avi', 'video/quicktime'];
    if (!supportedTypes.includes(file.type)) {
        alert('ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. MP4, WebM, AVI, MOV íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        input.value = '';
        return;
    }
    
    // íŒŒì¼ ì •ë³´ í‘œì‹œ
    const fileSize = (file.size / (1024 * 1024)).toFixed(2);
    document.getElementById('videoInfo').textContent = `${file.name} (${fileSize}MB)`;
    
    // ì œëª© ìë™ ì„¤ì •
    if (!document.getElementById('title').value) {
        document.getElementById('title').value = file.name.replace(/\.[^/.]+$/, '');
    }
    
    // ë¹„ë””ì˜¤ ë¯¸ë¦¬ë³´ê¸°
    const video = document.getElementById('previewVideo');
    const url = URL.createObjectURL(file);
    video.src = url;
    
    // ì—…ë¡œë“œ ì˜ì—­ ìˆ¨ê¸°ê³  ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
    document.getElementById('videoDropZone').style.display = 'none';
    document.getElementById('local-preview').style.display = 'block';
}

// ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì²˜ë¦¬
function handleDragOver(event) {
    event.preventDefault();
    event.currentTarget.classList.add('drag-over');
}

function handleDrop(event) {
    event.preventDefault();
    event.currentTarget.classList.remove('drag-over');
    
    const files = event.dataTransfer.files;
    if (files.length > 0) {
        const file = files[0];
        if (file.type.startsWith('video/')) {
            document.getElementById('video_file').files = files;
            handleVideoFileUpload(document.getElementById('video_file'));
        } else {
            alert('ë¹„ë””ì˜¤ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        }
    }
}

// ë¹„ë””ì˜¤ íŒŒì¼ ì œê±°
function removeVideoFile() {
    document.getElementById('video_file').value = '';
    document.getElementById('previewVideo').src = '';
    document.getElementById('videoDropZone').style.display = 'block';
    document.getElementById('local-preview').style.display = 'none';
}

// ì»¤ìŠ¤í…€ ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸°
function previewThumbnail(input) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('preview-thumbnail').src = e.target.result;
        document.getElementById('thumbnail-preview').style.display = 'block';
    };
    reader.readAsDataURL(file);
}

// í¼ ì œì¶œ ì²˜ë¦¬
document.getElementById('addVideoForm').addEventListener('submit', function(event) {
    event.preventDefault();
    
    // ìœ íš¨ì„± ê²€ì‚¬
    if (!validateForm()) {
        return;
    }
    
    // ì œì¶œ ë²„íŠ¼ ë¹„í™œì„±í™”
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'ì¶”ê°€ ì¤‘...';
    submitBtn.style.background = '#6c757d';
    
    // FormData ìƒì„±
    const formData = new FormData();
    
    // ê³µí†µ í•„ë“œ
    formData.append('platform', currentPlatform);
    formData.append('title', document.getElementById('title').value);
    formData.append('description', document.getElementById('description').value);
    formData.append('author', document.getElementById('author').value);
    formData.append('performance_date', document.getElementById('performance_date').value);
    formData.append('tags', document.getElementById('tags').value);
    
    // í”Œë«í¼ë³„ í•„ë“œ
    if (currentPlatform === 'youtube') {
        formData.append('video_url', document.getElementById('youtube_url').value);
    } else if (currentPlatform === 'local') {
        const videoFile = document.getElementById('video_file').files[0];
        if (videoFile) {
            formData.append('video_file', videoFile);
        }
    }
    
    // ì»¤ìŠ¤í…€ ì¸ë„¤ì¼
    const thumbnailFile = document.getElementById('custom_thumbnail').files[0];
    if (thumbnailFile) {
        formData.append('custom_thumbnail', thumbnailFile);
    }
    
    // AJAX ì œì¶œ
    fetch('/add_video', {
        method: 'POST',
        body: formData
    }).then(response => {
        if (response.ok) {
            alert('ì˜ìƒì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
            window.location.href = '/portfolio';
        } else {
            return response.text().then(text => {
                throw new Error(text);
            });
        }
    }).catch(error => {
        console.error('Error:', error);
        alert('ì˜ìƒ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        resetSubmitButton();
    });
});

// í¼ ìœ íš¨ì„± ê²€ì‚¬
function validateForm() {
    const title = document.getElementById('title').value.trim();
    if (!title) {
        alert('ì˜ìƒ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        document.getElementById('title').focus();
        return false;
    }
    
    if (currentPlatform === 'youtube') {
        const url = document.getElementById('youtube_url').value.trim();
        if (!url) {
            alert('YouTube URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            document.getElementById('youtube_url').focus();
            return false;
        }
        if (!extractYouTubeVideoId(url)) {
            alert('ì˜¬ë°”ë¥¸ YouTube URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            document.getElementById('youtube_url').focus();
            return false;
        }
    } else if (currentPlatform === 'local') {
        const file = document.getElementById('video_file').files[0];
        if (!file) {
            alert('ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return false;
        }
    }
    
    return true;
}

// ì œì¶œ ë²„íŠ¼ ë¦¬ì…‹
function resetSubmitButton() {
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = false;
    submitBtn.textContent = 'ì˜ìƒ ì¶”ê°€';
    submitBtn.style.background = '#8b7355';
}

// íƒœê·¸ ì…ë ¥ ë„ìš°ë¯¸
document.getElementById('tags').addEventListener('input', function(event) {
    let value = event.target.value;
    // ì—°ì†ëœ ì‰¼í‘œë‚˜ ê³µë°± ì •ë¦¬
    value = value.replace(/,+/g, ',').replace(/\s+,/g, ',').replace(/,\s+/g, ', ');
    if (value !== event.target.value) {
        event.target.value = value;
    }
});

// í˜ì´ì§€ ì´íƒˆ ê²½ê³ 
let formChanged = false;

// í¼ ë³€ê²½ ê°ì§€
document.querySelectorAll('#addVideoForm input, #addVideoForm textarea, #addVideoForm select').forEach(element => {
    element.addEventListener('change', function() {
        formChanged = true;
    });
});

// í˜ì´ì§€ ì´íƒˆ ì‹œ ê²½ê³ 
window.addEventListener('beforeunload', function(event) {
    if (formChanged && !document.getElementById('submitBtn').disabled) {
        event.preventDefault();
        event.returnValue = 'ë³€ê²½ì‚¬í•­ì´ ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ë– ë‚˜ì‹œê² ìŠµë‹ˆê¹Œ?';
        return event.returnValue;
    }
});

// í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
document.addEventListener('keydown', function(event) {
    // Ctrl+Enterë¡œ í¼ ì œì¶œ
    if (event.ctrlKey && event.key === 'Enter') {
        event.preventDefault();
        document.getElementById('addVideoForm').dispatchEvent(new Event('submit'));
    }
    
    // ìˆ«ì í‚¤ë¡œ í”Œë«í¼ ì „í™˜
    if (event.key === '1') {
        switchPlatform('youtube');
    } else if (event.key === '2') {
        switchPlatform('local');
    }
    
    // ESCë¡œ ì·¨ì†Œ
    if (event.key === 'Escape') {
        if (confirm('ì˜ìƒ ì¶”ê°€ë¥¼ ì·¨ì†Œí•˜ê³  í¬íŠ¸í´ë¦¬ì˜¤ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            window.location.href = '/portfolio';
        }
    }
});

// ë“œë˜ê·¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
document.addEventListener('DOMContentLoaded', function() {
    const videoDropZone = document.getElementById('videoDropZone');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        videoDropZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    ['dragenter', 'dragover'].forEach(eventName => {
        videoDropZone.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        videoDropZone.addEventListener(eventName, unhighlight, false);
    });
    
    videoDropZone.addEventListener('drop', handleDrop, false);
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    function highlight(e) {
        videoDropZone.classList.add('drag-over');
    }
    
    function unhighlight(e) {
        videoDropZone.classList.remove('drag-over');
    }
    
    // ì´ˆê¸° í¼ ìœ íš¨ì„± ê²€ì‚¬ ì„¤ì •
    updateFormValidation();
});

// URL íŒŒë¼ë¯¸í„°ë¡œ í”Œë«í¼ ì„¤ì • (ì„ íƒì‚¬í•­)
const urlParams = new URLSearchParams(window.location.search);
const platformParam = urlParams.get('platform');
if (platformParam && ['youtube', 'local'].includes(platformParam)) {
    switchPlatform(platformParam);
}

// ìë™ ì €ì¥ ê¸°ëŠ¥ (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€)
function autoSave() {
    if (typeof(Storage) !== "undefined") {
        const formData = {
            platform: currentPlatform,
            title: document.getElementById('title').value,
            description: document.getElementById('description').value,
            author: document.getElementById('author').value,
            performance_date: document.getElementById('performance_date').value,
            tags: document.getElementById('tags').value,
            youtube_url: document.getElementById('youtube_url').value
        };
        localStorage.setItem('video_form_draft', JSON.stringify(formData));
    }
}

// ì„ì‹œ ì €ì¥ëœ ë°ì´í„° ë³µì›
function restoreFromAutoSave() {
    if (typeof(Storage) !== "undefined") {
        const saved = localStorage.getItem('video_form_draft');
        if (saved && confirm('ì´ì „ì— ì‘ì„± ì¤‘ì´ë˜ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            const formData = JSON.parse(saved);
            
            if (formData.platform) {
                switchPlatform(formData.platform);
            }
            document.getElementById('title').value = formData.title || '';
            document.getElementById('description').value = formData.description || '';
            document.getElementById('author').value = formData.author || '';
            document.getElementById('performance_date').value = formData.performance_date || '';
            document.getElementById('tags').value = formData.tags || '';
            document.getElementById('youtube_url').value = formData.youtube_url || '';
        }
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì €ì¥ ë³µì›
window.addEventListener('load', function() {
    restoreFromAutoSave();
});

// ì…ë ¥ ì‹œ ìë™ ì €ì¥
let autoSaveTimer;
document.querySelectorAll('#addVideoForm input, #addVideoForm textarea').forEach(element => {
    element.addEventListener('input', function() {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(autoSave, 2000); // 2ì´ˆ í›„ ìë™ ì €ì¥
    });
});

// í¼ ì œì¶œ ì„±ê³µ ì‹œ ì„ì‹œ ì €ì¥ ë°ì´í„° ì‚­ì œ
function clearAutoSave() {
    if (typeof(Storage) !== "undefined") {
        localStorage.removeItem('video_form_draft');
    }
}
</script>

{% endblock %}