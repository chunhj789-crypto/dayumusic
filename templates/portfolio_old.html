{% extends "base.html" %}
{% block title %}ì˜ìƒ í¬íŠ¸í´ë¦¬ì˜¤{% endblock %}
{% block content %}

<section style="max-width: 1200px; margin: 0 auto; padding: 40px 30px;">
    
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div style="text-align: center; margin-bottom: 40px;">
        <h1 style="font-size: 2.2em; color: #2c3e50; font-weight: 300; margin: 0;">ì˜ìƒ í¬íŠ¸í´ë¦¬ì˜¤</h1>
        <div style="width: 50px; height: 2px; background: #8b7355; margin: 20px auto;"></div>
        <p style="color: #666; font-size: 1em;">ì•™ìƒë¸” ë‹¤ìœ ì˜ ì—°ì£¼ ì˜ìƒì„ ê°ìƒí•˜ì„¸ìš”</p>
    </div>

    <!-- í•„í„° ë° ê²€ìƒ‰ -->
    <div style="background: #ffffff; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 25px; margin-bottom: 30px;">
        <form method="GET" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
            <!-- ê²€ìƒ‰ì–´ -->
            <div style="flex: 1; min-width: 250px;">
                <input type="text" 
                       name="search" 
                       value="{{ request.args.get('search', '') }}"
                       placeholder="ì œëª©, ì„¤ëª…, íƒœê·¸ë¡œ ê²€ìƒ‰..."
                       style="width: 100%; padding: 10px 15px; border: 1px solid #ddd; border-radius: 25px; font-size: 0.9rem;">
            </div>
            
            <!-- í”Œë«í¼ í•„í„° -->
            <div>
                <select name="platform" style="padding: 10px 15px; border: 1px solid #ddd; border-radius: 25px; font-size: 0.9rem; background: white;">
                    <option value="">ì „ì²´ í”Œë«í¼</option>
                    <option value="youtube" {% if request.args.get('platform') == 'youtube' %}selected{% endif %}>YouTube</option>
                    <option value="vimeo" {% if request.args.get('platform') == 'vimeo' %}selected{% endif %}>Vimeo</option>
                    <option value="local" {% if request.args.get('platform') == 'local' %}selected{% endif %}>ë¡œì»¬ íŒŒì¼</option>
                </select>
            </div>
            
            <!-- ì •ë ¬ -->
            <div>
                <select name="sort" style="padding: 10px 15px; border: 1px solid #ddd; border-radius: 25px; font-size: 0.9rem; background: white;">
                    <option value="newest" {% if request.args.get('sort') == 'newest' %}selected{% endif %}>ìµœì‹ ìˆœ</option>
                    <option value="oldest" {% if request.args.get('sort') == 'oldest' %}selected{% endif %}>ì˜¤ë˜ëœìˆœ</option>
                    <option value="popular" {% if request.args.get('sort') == 'popular' %}selected{% endif %}>ì¸ê¸°ìˆœ</option>
                    <option value="title" {% if request.args.get('sort') == 'title' %}selected{% endif %}>ì œëª©ìˆœ</option>
                </select>
            </div>
            
            <!-- ê²€ìƒ‰ ë²„íŠ¼ -->
            <button type="submit" 
                    style="background: #8b7355; color: white; padding: 10px 20px; border: none; border-radius: 25px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s ease;"
                    onmouseover="this.style.background='#6d5a42'"
                    onmouseout="this.style.background='#8b7355'">
                ğŸ” ê²€ìƒ‰
            </button>
            
            <!-- ì˜ìƒ ì¶”ê°€ ë²„íŠ¼ (ê´€ë¦¬ìë§Œ í‘œì‹œ) -->
            {% if is_admin %}
            <a href="/add_video" 
               style="display: inline-block; background-color: #3a7ca5; color: white; padding: 10px 20px; text-decoration: none; border-radius: 25px; font-weight: 400; transition: all 0.3s ease;"
               onmouseover="this.style.background='#2c5973'"
               onmouseout="this.style.background='#3a7ca5'">
                â• ì˜ìƒ ì¶”ê°€
            </a>
            {% endif %}
        </form>
    </div>

    <!-- ì˜ìƒ ëª©ë¡ (ì¹´ë“œ í˜•íƒœ) -->
    {% if videos %}
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px;">
            {% for video in videos %}
            <div class="video-card" 
                 style="background: #ffffff; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #f0f0f0; transition: transform 0.3s ease, box-shadow 0.3s ease;"
                 onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 30px rgba(0,0,0,0.15)'"
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(0,0,0,0.08)'">
                
                <!-- ì˜ìƒ í”Œë ˆì´ì–´ ì˜ì—­ -->
                <div style="position: relative; height: 250px; background: #000; cursor: pointer;" onclick="window.open('{{ video.external_url }}', '_blank')">
                    {% if video.platform == 'youtube' %}
                        <!-- YouTube ì¸ë„¤ì¼ -->
    <!-- ê°€ì¥ ì‘ì€ í¬ê¸°ë¶€í„° ì‹œì‘ (ë” ì•ˆì •ì ) -->
    <img src="https://img.youtube.com/vi/{{ video.video_id }}/hqdefault.jpg" 
         alt="{{ video.title }}" 
         style="width: 100%; height: 100%; object-fit: cover;"
         onload="console.log('ì¸ë„¤ì¼ ë¡œë”© ì„±ê³µ: {{ video.video_id }}')"
         onerror="handleThumbnailError(this, '{{ video.video_id }}')">
    
    <!-- YouTube í”Œë ˆì´ ë²„íŠ¼ -->
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,0,0,0.8); border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
        <span style="color: white; font-size: 1.5em; margin-left: 3px;">â–¶</span>
    </div>        
                        
                        <!-- í”Œë«í¼ ë°°ì§€ -->
                        <div style="position: absolute; top: 10px; left: 10px; background: #ff0000; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.7em; font-weight: 500;">
                            YouTube
                        </div>
                        
                    {% elif video.platform == 'vimeo' %}
                        <!-- Vimeo ì¸ë„¤ì¼ (APIë¥¼ í†µí•´ ê°€ì ¸ì™€ì•¼ í•¨) -->
                        {% if video.thumbnail_url %}
                            <img src="{{ video.thumbnail_url }}" 
                                 alt="{{ video.title }}" 
                                 style="width: 100%; height: 100%; object-fit: cover;">
                        {% else %}
                            <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #1ab7ea, #1563d1); display: flex; align-items: center; justify-content: center;">
                                <span style="color: white; font-size: 3em; opacity: 0.7;">ğŸ¬</span>
                            </div>
                        {% endif %}
                        
                        <!-- Vimeo í”Œë ˆì´ ë²„íŠ¼ -->
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(26,183,234,0.8); border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
                            <span style="color: white; font-size: 1.5em; margin-left: 3px;">â–¶</span>
                        </div>
                        
                        <!-- í”Œë«í¼ ë°°ì§€ -->
                        <div style="position: absolute; top: 10px; left: 10px; background: #1ab7ea; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.7em; font-weight: 500;">
                            Vimeo
                        </div>
                        
                    {% else %}
                        <!-- ë¡œì»¬ íŒŒì¼ ë˜ëŠ” ê¸°ë³¸ ì¸ë„¤ì¼ -->
                        {% if video.thumbnail_filename %}
                            <img src="{{ url_for('static', filename='uploads/thumbnails/' + video.thumbnail_filename) }}" 
                                 alt="{{ video.title }}" 
                                 style="width: 100%; height: 100%; object-fit: cover;">
                        {% else %}
                            <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #8b7355, #a08266); display: flex; align-items: center; justify-content: center;">
                                <span style="color: white; font-size: 3em; opacity: 0.7;">ğŸ¼</span>
                            </div>
                        {% endif %}
                        
                        <!-- í”Œë ˆì´ ë²„íŠ¼ -->
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(139,115,85,0.8); border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
                            <span style="color: white; font-size: 1.5em; margin-left: 3px;">â–¶</span>
                        </div>
                        
                        <!-- í”Œë«í¼ ë°°ì§€ -->
                        <div style="position: absolute; top: 10px; left: 10px; background: #8b7355; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.7em; font-weight: 500;">
                            ë¡œì»¬
                        </div>
                    {% endif %}
                    
                    <!-- ì¬ìƒ ì‹œê°„ í‘œì‹œ -->
                    {% if video.duration %}
                    <div style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em;">
                        {{ video.duration }}
                    </div>
                    {% endif %}
                </div>
                
                <!-- ì˜ìƒ ì •ë³´ -->
                <div style="padding: 20px;">
                    <div style="margin-bottom: 15px;">
                        <h3 style="font-size: 1.3em; color: #2c3e50; margin: 0 0 8px 0; font-weight: 500; line-height: 1.3;">
                            {{ video.title }}
                        </h3>
                        <div style="color: #999; font-size: 0.9em; margin-bottom: 12px;">
                            <span style="color: #8b7355; font-weight: 400;">{{ video.author or 'ì•™ìƒë¸” ë‹¤ìœ ' }}</span> | 
                            {{ video.date_uploaded.strftime('%Y.%m.%d') }}
                            {% if video.performance_date %}
                                <span style="color: #999;"> â€¢ ê³µì—°ì¼: {{ video.performance_date.strftime('%Y.%m.%d') }}</span>
                            {% endif %}
                            {% if is_admin %}
                                <span style="background: #8b7355; color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.75em; margin-left: 8px;">ê´€ë¦¬ì</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- ì˜ìƒ ì„¤ëª… -->
                    {% if video.description %}
                    <p style="color: #555; line-height: 1.6; margin: 0 0 15px 0; font-size: 0.95em;">
                        {% if video.description|length > 80 %}
                            {{ video.description[:80] }}...
                        {% else %}
                            {{ video.description }}
                        {% endif %}
                    </p>
                    {% endif %}
                    
                    <!-- íƒœê·¸ -->
                    {% if video.tags %}
                    <div style="margin-bottom: 15px;">
                        {% for tag in video.tags.split(',')[:3] %}
                        <span style="display: inline-block; background: #f0f9ff; color: #3a7ca5; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin: 2px 4px 2px 0;">
                            #{{ tag.strip() }}
                        </span>
                        {% endfor %}
                        {% if video.tags.split(',')|length > 3 %}
                        <span style="color: #999; font-size: 0.8em;">+{{ video.tags.split(',')|length - 3 }}ê°œ</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- ì•¡ì…˜ ë²„íŠ¼ -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <!-- ì¡°íšŒìˆ˜ -->
                            <span style="color: #999; font-size: 0.9em;">
                                ğŸ‘ï¸ {{ video.view_count or 0 }}íšŒ
                            </span>
                            
                            <!-- ì¢‹ì•„ìš” -->
                            <span style="color: #999; font-size: 0.9em; cursor: pointer;" onclick="likeVideo({{ video.id }}, event)">
                                â¤ï¸ <span id="like-count-{{ video.id }}">{{ video.like_count or 0 }}</span>
                            </span>
                            
                            <!-- ì™¸ë¶€ ë§í¬ -->
                            {% if video.platform in ['youtube', 'vimeo'] %}
                            <a href="{{ video.external_url }}" target="_blank" 
                               style="color: #8b7355; text-decoration: none; font-size: 0.9em;"
                               onclick="event.stopPropagation();">
                                ğŸ”— ì›ë³¸ ë³´ê¸°
                            </a>
                            {% endif %}
                        </div>
                        
                        <!-- ê´€ë¦¬ì ì•¡ì…˜ ë²„íŠ¼ -->
                        {% if is_admin %}
                        <div style="display: flex; gap: 8px;">
                            <a href="/edit_video/{{ video.id }}" 
                               style="color: #8b7355; text-decoration: none; padding: 6px 12px; border: 1px solid #8b7355; border-radius: 15px; font-size: 0.8em; transition: all 0.3s ease;"
                               onclick="event.stopPropagation()"
                               onmouseover="this.style.background='#8b7355'; this.style.color='white'"
                               onmouseout="this.style.background='transparent'; this.style.color='#8b7355'">
                                ìˆ˜ì •
                            </a>
                            <button onclick="deleteVideo({{ video.id }}, event)" 
                                    style="color: #dc3545; background: transparent; border: 1px solid #dc3545; padding: 6px 12px; border-radius: 15px; font-size: 0.8em; cursor: pointer; transition: all 0.3s ease;"
                                    onmouseover="this.style.background='#dc3545'; this.style.color='white'"
                                    onmouseout="this.style.background='transparent'; this.style.color='#dc3545'">
                                ì‚­ì œ
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
        {% if pagination and pagination.pages > 1 %}
        <div style="text-align: center; margin-top: 40px;">
            <div style="display: inline-flex; gap: 10px; align-items: center;">
                {% if pagination.has_prev %}
                <a href="{{ url_for('portfolio', page=pagination.prev_num, **request.args) }}" 
                   style="padding: 8px 16px; background: #f8f9fa; color: #8b7355; text-decoration: none; border-radius: 20px; transition: all 0.3s ease;"
                   onmouseover="this.style.background='#8b7355'; this.style.color='white'"
                   onmouseout="this.style.background='#f8f9fa'; this.style.color='#8b7355'">
                    ì´ì „
                </a>
                {% endif %}
                
                {% for page_num in pagination.iter_pages() %}
                    {% if page_num %}
                        {% if page_num != pagination.page %}
                        <a href="{{ url_for('portfolio', page=page_num, **request.args) }}" 
                           style="padding: 8px 12px; background: #f8f9fa; color: #666; text-decoration: none; border-radius: 20px; transition: all 0.3s ease;"
                           onmouseover="this.style.background='#e9ecef'"
                           onmouseout="this.style.background='#f8f9fa'">
                            {{ page_num }}
                        </a>
                        {% else %}
                        <span style="padding: 8px 12px; background: #8b7355; color: white; border-radius: 20px;">
                            {{ page_num }}
                        </span>
                        {% endif %}
                    {% else %}
                        <span style="padding: 8px 12px;">...</span>
                    {% endif %}
                {% endfor %}
                
                {% if pagination.has_next %}
                <a href="{{ url_for('portfolio', page=pagination.next_num, **request.args) }}" 
                   style="padding: 8px 16px; background: #f8f9fa; color: #8b7355; text-decoration: none; border-radius: 20px; transition: all 0.3s ease;"
                   onmouseover="this.style.background='#8b7355'; this.style.color='white'"
                   onmouseout="this.style.background='#f8f9fa'; this.style.color='#8b7355'">
                    ë‹¤ìŒ
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
    {% else %}
        <!-- ì˜ìƒì´ ì—†ëŠ” ê²½ìš° -->
        <div style="text-align: center; padding: 80px 20px; background: #f8f9fa; border-radius: 12px; border: 2px dashed #ddd;">
            <div style="font-size: 3em; margin-bottom: 20px; opacity: 0.5;">ğŸ¬</div>
            {% if request.args.get('search') or request.args.get('platform') %}
                <h3 style="color: #666; margin: 0 0 15px 0; font-weight: 300;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                <p style="color: #999; margin: 0 0 25px 0;">ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë‚˜ í•„í„°ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”</p>
                <a href="/portfolio" 
                   style="display: inline-block; background-color: #8b7355; color: white; padding: 12px 24px; text-decoration: none; border-radius: 25px; font-weight: 400;">
                    ì „ì²´ ì˜ìƒ ë³´ê¸°
                </a>
            {% else %}
                <h3 style="color: #666; margin: 0 0 15px 0; font-weight: 300;">ì•„ì§ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤</h3>
                <p style="color: #999; margin: 0 0 25px 0;">ì²« ë²ˆì§¸ ì˜ìƒì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
                {% if is_admin %}
                <a href="/add_video" 
                   style="display: inline-block; background-color: #8b7355; color: white; padding: 12px 24px; text-decoration: none; border-radius: 25px; font-weight: 400;">
                    ì˜ìƒ ì¶”ê°€
                </a>
                {% endif %}
            {% endif %}
        </div>
    {% endif %}

</section>

<!-- ì˜ìƒ ëª¨ë‹¬ -->
<div id="videoModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; padding: 20px; box-sizing: border-box;">
    <div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
        <button onclick="closeVideoModal()" 
                style="position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.5); border: none; color: white; font-size: 2em; cursor: pointer; z-index: 1001; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
            âœ•
        </button>
        <div id="modalContent" style="max-width: 90%; max-height: 90%; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
            <!-- ë™ì ìœ¼ë¡œ iframe ë˜ëŠ” video íƒœê·¸ê°€ ì‚½ì…ë©ë‹ˆë‹¤ -->
        </div>
    </div>
</div>

<style>
/* ë°˜ì‘í˜• ë””ìì¸ */
@media (max-width: 768px) {
    section {
        padding: 20px 15px !important;
    }
    
    .video-grid {
        grid-template-columns: 1fr !important;
    }
    
    .video-card {
        margin-bottom: 20px;
    }
    
    .search-form {
        flex-direction: column !important;
        align-items: stretch !important;
    }
    
    .search-form > div {
        margin-bottom: 10px;
    }
    
    .search-form button {
        width: 100% !important;
    }
}

@media (max-width: 480px) {
    h1 {
        font-size: 1.8em !important;
    }
    
    .video-card > div:last-child {
        padding: 15px !important;
    }
    
    .video-card .video-thumbnail {
        height: 200px !important;
    }
    
    .pagination {
        flex-wrap: wrap !important;
        gap: 5px !important;
    }
}

/* í˜¸ë²„ íš¨ê³¼ ê°œì„  */
.video-card:hover .video-thumbnail img {
    transform: scale(1.05);
    transition: transform 0.3s ease;
}

/* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.loading {
    animation: pulse 1.5s infinite;
}
</style>

<script>
// ì˜ìƒ ëª¨ë‹¬ ì—´ê¸°
function openVideoModal(videoId) {
    fetch(`/api/video/${videoId}`)
        .then(response => response.json())
        .then(video => {
            const modal = document.getElementById('videoModal');
            const content = document.getElementById('modalContent');
            
            let videoElement = '';
            
            if (video.platform === 'youtube') {
                videoElement = `
                    <iframe width="100%" height="100%" 
                            src="https://www.youtube.com/embed/${video.video_id}?autoplay=1&rel=0" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen
                            style="max-width: 1200px; max-height: 675px; aspect-ratio: 16/9;">
                    </iframe>`;
            } else if (video.platform === 'vimeo') {
                videoElement = `
                    <iframe width="100%" height="100%" 
                            src="https://player.vimeo.com/video/${video.video_id}?autoplay=1" 
                            frameborder="0" 
                            allow="autoplay; fullscreen; picture-in-picture" 
                            allowfullscreen
                            style="max-width: 1200px; max-height: 675px; aspect-ratio: 16/9;">
                    </iframe>`;
            } else {
                // ë¡œì»¬ íŒŒì¼
                videoElement = `
                    <video controls autoplay 
                           style="max-width: 100%; max-height: 100%; object-fit: contain;">
                        <source src="${video.video_url}" type="video/mp4">
                        ë¸Œë¼ìš°ì €ê°€ ë¹„ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </video>`;
            }
            
            content.innerHTML = videoElement;
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // ì¡°íšŒìˆ˜ ì¦ê°€
            updateViewCount(videoId);
        })
        .catch(error => {
            console.error('Error loading video:', error);
            alert('ì˜ìƒì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        });
}

// ì˜ìƒ ëª¨ë‹¬ ë‹«ê¸°
function closeVideoModal() {
    const modal = document.getElementById('videoModal');
    const content = document.getElementById('modalContent');
    modal.style.display = 'none';
    content.innerHTML = '';
    document.body.style.overflow = 'auto';
}

// ì¢‹ì•„ìš” ê¸°ëŠ¥
function likeVideo(videoId, event) {
    event.stopPropagation();
    
    fetch(`/api/video/${videoId}/like`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    }).then(response => response.json())
      .then(data => {
          if (data.success) {
              const likeCountElement = document.getElementById(`like-count-${videoId}`);
              likeCountElement.textContent = data.like_count;
              
              // ì¢‹ì•„ìš” ì• ë‹ˆë©”ì´ì…˜
              likeCountElement.style.transform = 'scale(1.2)';
              likeCountElement.style.color = '#ff6b6b';
              
              setTimeout(() => {
                  likeCountElement.style.transform = 'scale(1)';
                  likeCountElement.style.color = '#999';
              }, 300);
          }
      }).catch(error => {
          console.error('Error:', error);
      });
}

// ì¡°íšŒìˆ˜ ì—…ë°ì´íŠ¸
function updateViewCount(videoId) {
    fetch(`/api/video/${videoId}/view`, {
        method: 'POST'
    }).catch(error => console.error('View count update failed:', error));
}

// ì˜ìƒ ì‚­ì œ
function deleteVideo(videoId, event) {
    event.stopPropagation();
    
    if (confirm('ì •ë§ë¡œ ì´ ì˜ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        fetch(`/api/video/${videoId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        }).then(response => response.json())
          .then(data => {
              if (data.success) {
                  location.reload();
              } else {
                  alert('ì˜ìƒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
              }
          }).catch(error => {
              console.error('Error:', error);
              alert('ì˜ìƒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          });
    }
}

// ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeVideoModal();
    }
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ URL íŒŒë¼ë¯¸í„° ìœ ì§€
document.addEventListener('DOMContentLoaded', function() {
    // ê²€ìƒ‰ í¼ ìë™ ì œì¶œ ë°©ì§€
    const searchForm = document.querySelector('form');
    if (searchForm) {
        searchForm.addEventListener('submit', function(e) {
            const searchInput = document.querySelector('input[name="search"]');
            if (searchInput && !searchInput.value.trim()) {
                searchInput.removeAttribute('name');
            }
        });
    }
});

// ë¬´í•œ ìŠ¤í¬ë¡¤ (ì„ íƒì‚¬í•­)
let isLoading = false;
function loadMoreVideos() {
    if (isLoading) return;
    
    const currentPage = {{ pagination.page if pagination else 1 }};
    const totalPages = {{ pagination.pages if pagination else 1 }};
    
    if (currentPage >= totalPages) return;
    
    isLoading = true;
    
    // ë¡œë”© í‘œì‹œ
    const loadingElement = document.createElement('div');
    loadingElement.className = 'loading';
    loadingElement.style.textAlign = 'center';
    loadingElement.style.padding = '20px';
    loadingElement.innerHTML = 'ë” ë§ì€ ì˜ìƒì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    
    document.querySelector('section').appendChild(loadingElement);
    
    // AJAXë¡œ ë‹¤ìŒ í˜ì´ì§€ ë¡œë“œ
    const nextPage = currentPage + 1;
    const url = new URL(window.location);
    url.searchParams.set('page', nextPage);
    
    fetch(url.toString())
        .then(response => response.text())
        .then(html => {
            // ìƒˆë¡œìš´ ë¹„ë””ì˜¤ ì¹´ë“œë“¤ì„ ì¶”ì¶œí•˜ì—¬ ì¶”ê°€
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newCards = doc.querySelectorAll('.video-card');
            
            const videoGrid = document.querySelector('.video-grid');
            newCards.forEach(card => {
                videoGrid.appendChild(card);
            });
            
            loadingElement.remove();
            isLoading = false;
        })
        .catch(error => {
            console.error('Error loading more videos:', error);
            loadingElement.remove();
            isLoading = false;
        });
}

// ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ë¡œ ë¬´í•œ ìŠ¤í¬ë¡¤ íŠ¸ë¦¬ê±°
window.addEventListener('scroll', function() {
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 1000) {
        loadMoreVideos();
    }
});
</script>
<script>
// ê°•ë ¥í•œ YouTube ì¸ë„¤ì¼ fallback ì‹œìŠ¤í…œ
function handleThumbnailError(img, videoId) {
    const fallbackSizes = [
        'maxresdefault',
        'hqdefault', 
        'mqdefault',
        'default'
    ];
    
    // í˜„ì¬ ì‹œë„í•˜ê³  ìˆëŠ” í¬ê¸° ì°¾ê¸°
    let currentIndex = -1;
    for (let i = 0; i < fallbackSizes.length; i++) {
        if (img.src.includes(fallbackSizes[i])) {
            currentIndex = i;
            break;
        }
    }
    
    // ë‹¤ìŒ í¬ê¸°ë¡œ ì‹œë„
    if (currentIndex < fallbackSizes.length - 1) {
        const nextSize = fallbackSizes[currentIndex + 1];
        img.src = `https://img.youtube.com/vi/${videoId}/${nextSize}.jpg`;
        console.log(`ì¸ë„¤ì¼ fallback: ${nextSize} ì‹œë„ ì¤‘...`);
        return;
    }
    
    // ëª¨ë“  ì¸ë„¤ì¼ ì‹¤íŒ¨ ì‹œ YouTube APIì—ì„œ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹œë„
    if (currentIndex >= fallbackSizes.length - 1) {
        tryYouTubeOEmbed(img, videoId);
    }
}

// YouTube oEmbed APIë¡œ ì¸ë„¤ì¼ ê°€ì ¸ì˜¤ê¸°
function tryYouTubeOEmbed(img, videoId) {
    const oEmbedUrl = `https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`;
    
    fetch(oEmbedUrl)
        .then(response => response.json())
        .then(data => {
            if (data.thumbnail_url) {
                img.src = data.thumbnail_url;
                console.log('oEmbed ì¸ë„¤ì¼ ì„±ê³µ:', data.thumbnail_url);
            } else {
                createFallbackThumbnail(img, videoId, data.title || '');
            }
        })
        .catch(error => {
            console.log('oEmbed ì‹¤íŒ¨, ê¸°ë³¸ ì¸ë„¤ì¼ ìƒì„±');
            createFallbackThumbnail(img, videoId, '');
        });
}

// ê¸°ë³¸ ì¸ë„¤ì¼ ìƒì„±
function createFallbackThumbnail(img, videoId, title) {
    const container = img.parentElement;
    container.innerHTML = `
        <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #ff0000, #cc0000); display: flex; align-items: center; justify-content: center; position: relative;">
            <div style="text-align: center; color: white; padding: 20px;">
                <div style="font-size: 2.5em; margin-bottom: 10px;">ğŸ“º</div>
                <div style="font-size: 1em; font-weight: 500; line-height: 1.3;">
                    ${title ? title.substring(0, 30) + (title.length > 30 ? '...' : '') : 'YouTube ì˜ìƒ'}
                </div>
                <div style="font-size: 0.8em; margin-top: 10px; opacity: 0.8;">
                    ID: ${videoId}
                </div>
            </div>
            <!-- í”Œë ˆì´ ë²„íŠ¼ -->
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.2); border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
                <span style="color: white; font-size: 1.5em; margin-left: 3px;">â–¶</span>
            </div>
        </div>
    `;
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë“  YouTube ì¸ë„¤ì¼ í™•ì¸
document.addEventListener('DOMContentLoaded', function() {
    const youtubeImages = document.querySelectorAll('img[src*="youtube.com"]');
    
    youtubeImages.forEach(img => {
        // ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ ì²´í¬
        if (img.complete) {
            // ì´ë¯¸ ë¡œë“œëœ ê²½ìš° í¬ê¸° ì²´í¬
            if (img.naturalWidth === 0 || img.naturalHeight === 0) {
                const videoId = extractVideoIdFromSrc(img.src);
                if (videoId) {
                    handleThumbnailError(img, videoId);
                }
            }
        }
        
        // ì—ëŸ¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        img.addEventListener('error', function() {
            const videoId = extractVideoIdFromSrc(this.src);
            if (videoId) {
                handleThumbnailError(this, videoId);
            }
        });
    });
});

// URLì—ì„œ YouTube ë¹„ë””ì˜¤ ID ì¶”ì¶œ
function extractVideoIdFromSrc(src) {
    const match = src.match(/\/vi\/([^\/]+)\//);
    return match ? match[1] : null;
}

// ì¸ë„¤ì¼ ì‚¬ì „ ê²€ì¦ í•¨ìˆ˜
async function validateYouTubeThumbnail(videoId) {
    const sizes = ['maxresdefault', 'hqdefault', 'mqdefault', 'default'];
    
    for (const size of sizes) {
        const url = `https://img.youtube.com/vi/${videoId}/${size}.jpg`;
        try {
            const response = await fetch(url, { method: 'HEAD' });
            if (response.ok) {
                return url;
            }
        } catch (error) {
            continue;
        }
    }
    
    return null; // ëª¨ë“  ì¸ë„¤ì¼ ì‹¤íŒ¨
}
</script>
{% if video.platform == 'youtube' %}
    <!-- ì¸ë„¤ì¼ ëŒ€ì‹  YouTube ìŠ¤íƒ€ì¼ ì¹´ë“œ -->
    <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #ff0000, #cc0000); display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; color: white;">
        
        <!-- YouTube ë¡œê³  ì˜ì—­ -->
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 3em; margin-bottom: 10px;">ğŸ“º</div>
            <div style="font-size: 1.2em; font-weight: bold; color: white;">YouTube</div>
        </div>
        
        <!-- ì˜ìƒ ì œëª© -->
        <div style="text-align: center; padding: 0 20px; flex: 1; display: flex; align-items: center;">
            <div style="font-size: 1.1em; font-weight: 500; line-height: 1.3; color: white;">
                {{ video.title[:50] }}{% if video.title|length > 50 %}...{% endif %}
            </div>
        </div>
        
        <!-- í”Œë ˆì´ ë²„íŠ¼ -->
        <div style="position: absolute; bottom: 20px; right: 20px; background: rgba(255,255,255,0.3); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
            <span style="color: white; font-size: 1.3em; margin-left: 2px;">â–¶</span>
        </div>
        
        <!-- Video ID í‘œì‹œ (ë””ë²„ê·¸ìš©) -->
        <div style="position: absolute; bottom: 5px; left: 5px; font-size: 0.7em; opacity: 0.7; color: white;">
            ID: {{ video.video_id }}
        </div>
    </div>
{% endif %}
{% endblock %}