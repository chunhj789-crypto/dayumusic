{% extends "base.html" %}
{% block title %}영상 포트폴리오{% endblock %}
{% block content %}

<section style="max-width: 1200px; margin: 0 auto; padding: 40px 30px;">
    
    <!-- 페이지 헤더 -->
    <div style="text-align: center; margin-bottom: 40px;">
        <h1 style="font-size: 2.2em; color: #2c3e50; font-weight: 300; margin: 0;">영상 포트폴리오</h1>
        <div style="width: 50px; height: 2px; background: #8b7355; margin: 20px auto;"></div>
        <p style="color: #666; font-size: 1em;">앙상블 다유의 연주 영상을 감상하세요</p>
    </div>

    <!-- 필터 및 검색 -->
    <div style="background: #ffffff; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 25px; margin-bottom: 30px;">
        <form method="GET" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
            <!-- 검색어 -->
            <div style="flex: 1; min-width: 250px;">
                <input type="text" 
                       name="search" 
                       value="{{ request.args.get('search', '') }}"
                       placeholder="제목, 설명, 태그로 검색..."
                       style="width: 100%; padding: 10px 15px; border: 1px solid #ddd; border-radius: 25px; font-size: 0.9rem;">
            </div>
            
            <!-- 플랫폼 필터 -->
            <div>
                <select name="platform" style="padding: 10px 15px; border: 1px solid #ddd; border-radius: 25px; font-size: 0.9rem; background: white;">
                    <option value="">전체 플랫폼</option>
                    <option value="youtube" {% if request.args.get('platform') == 'youtube' %}selected{% endif %}>YouTube</option>
                    <option value="vimeo" {% if request.args.get('platform') == 'vimeo' %}selected{% endif %}>Vimeo</option>
                    <option value="local" {% if request.args.get('platform') == 'local' %}selected{% endif %}>로컬 파일</option>
                </select>
            </div>
            
            <!-- 정렬 -->
            <div>
                <select name="sort" style="padding: 10px 15px; border: 1px solid #ddd; border-radius: 25px; font-size: 0.9rem; background: white;">
                    <option value="newest" {% if request.args.get('sort') == 'newest' %}selected{% endif %}>최신순</option>
                    <option value="oldest" {% if request.args.get('sort') == 'oldest' %}selected{% endif %}>오래된순</option>
                    <option value="popular" {% if request.args.get('sort') == 'popular' %}selected{% endif %}>인기순</option>
                    <option value="title" {% if request.args.get('sort') == 'title' %}selected{% endif %}>제목순</option>
                </select>
            </div>
            
            <!-- 검색 버튼 -->
            <button type="submit" 
                    style="background: #8b7355; color: white; padding: 10px 20px; border: none; border-radius: 25px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s ease;"
                    onmouseover="this.style.background='#6d5a42'"
                    onmouseout="this.style.background='#8b7355'">
                🔍 검색
            </button>
            
            <!-- 영상 추가 버튼 (관리자만 표시) -->
            {% if is_admin %}
            <a href="/add_video" 
               style="display: inline-block; background-color: #3a7ca5; color: white; padding: 10px 20px; text-decoration: none; border-radius: 25px; font-weight: 400; transition: all 0.3s ease;"
               onmouseover="this.style.background='#2c5973'"
               onmouseout="this.style.background='#3a7ca5'">
                ➕ 영상 추가
            </a>
            {% endif %}
        </form>
    </div>

    <!-- 영상 목록 (카드 형태) -->
    {% if videos %}
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px;">
            {% for video in videos %}
            <div class="video-card" 
                 style="background: #ffffff; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #f0f0f0; transition: transform 0.3s ease, box-shadow 0.3s ease;"
                 onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 30px rgba(0,0,0,0.15)'"
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(0,0,0,0.08)'">
                
                <!-- 영상 플레이어 영역 -->
                <div style="position: relative; height: 250px; background: #000; cursor: pointer;" onclick="window.open('{{ video.external_url }}', '_blank')">
                    {% if video.platform == 'youtube' %}
                        <!-- YouTube 썸네일 -->
    <!-- 가장 작은 크기부터 시작 (더 안정적) -->
    <img src="https://img.youtube.com/vi/{{ video.video_id }}/hqdefault.jpg" 
         alt="{{ video.title }}" 
         style="width: 100%; height: 100%; object-fit: cover;"
         onload="console.log('썸네일 로딩 성공: {{ video.video_id }}')"
         onerror="handleThumbnailError(this, '{{ video.video_id }}')">
    
    <!-- YouTube 플레이 버튼 -->
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,0,0,0.8); border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
        <span style="color: white; font-size: 1.5em; margin-left: 3px;">▶</span>
    </div>        
                        
                        <!-- 플랫폼 배지 -->
                        <div style="position: absolute; top: 10px; left: 10px; background: #ff0000; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.7em; font-weight: 500;">
                            YouTube
                        </div>
                        
                    {% elif video.platform == 'vimeo' %}
                        <!-- Vimeo 썸네일 (API를 통해 가져와야 함) -->
                        {% if video.thumbnail_url %}
                            <img src="{{ video.thumbnail_url }}" 
                                 alt="{{ video.title }}" 
                                 style="width: 100%; height: 100%; object-fit: cover;">
                        {% else %}
                            <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #1ab7ea, #1563d1); display: flex; align-items: center; justify-content: center;">
                                <span style="color: white; font-size: 3em; opacity: 0.7;">🎬</span>
                            </div>
                        {% endif %}
                        
                        <!-- Vimeo 플레이 버튼 -->
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(26,183,234,0.8); border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
                            <span style="color: white; font-size: 1.5em; margin-left: 3px;">▶</span>
                        </div>
                        
                        <!-- 플랫폼 배지 -->
                        <div style="position: absolute; top: 10px; left: 10px; background: #1ab7ea; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.7em; font-weight: 500;">
                            Vimeo
                        </div>
                        
                    {% else %}
                        <!-- 로컬 파일 또는 기본 썸네일 -->
                        {% if video.thumbnail_filename %}
                            <img src="{{ url_for('static', filename='uploads/thumbnails/' + video.thumbnail_filename) }}" 
                                 alt="{{ video.title }}" 
                                 style="width: 100%; height: 100%; object-fit: cover;">
                        {% else %}
                            <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #8b7355, #a08266); display: flex; align-items: center; justify-content: center;">
                                <span style="color: white; font-size: 3em; opacity: 0.7;">🎼</span>
                            </div>
                        {% endif %}
                        
                        <!-- 플레이 버튼 -->
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(139,115,85,0.8); border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
                            <span style="color: white; font-size: 1.5em; margin-left: 3px;">▶</span>
                        </div>
                        
                        <!-- 플랫폼 배지 -->
                        <div style="position: absolute; top: 10px; left: 10px; background: #8b7355; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.7em; font-weight: 500;">
                            로컬
                        </div>
                    {% endif %}
                    
                    <!-- 재생 시간 표시 -->
                    {% if video.duration %}
                    <div style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em;">
                        {{ video.duration }}
                    </div>
                    {% endif %}
                </div>
                
                <!-- 영상 정보 -->
                <div style="padding: 20px;">
                    <div style="margin-bottom: 15px;">
                        <h3 style="font-size: 1.3em; color: #2c3e50; margin: 0 0 8px 0; font-weight: 500; line-height: 1.3;">
                            {{ video.title }}
                        </h3>
                        <div style="color: #999; font-size: 0.9em; margin-bottom: 12px;">
                            <span style="color: #8b7355; font-weight: 400;">{{ video.author or '앙상블 다유' }}</span> | 
                            {{ video.date_uploaded.strftime('%Y.%m.%d') }}
                            {% if video.performance_date %}
                                <span style="color: #999;"> • 공연일: {{ video.performance_date.strftime('%Y.%m.%d') }}</span>
                            {% endif %}
                            {% if is_admin %}
                                <span style="background: #8b7355; color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.75em; margin-left: 8px;">관리자</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- 영상 설명 -->
                    {% if video.description %}
                    <p style="color: #555; line-height: 1.6; margin: 0 0 15px 0; font-size: 0.95em;">
                        {% if video.description|length > 80 %}
                            {{ video.description[:80] }}...
                        {% else %}
                            {{ video.description }}
                        {% endif %}
                    </p>
                    {% endif %}
                    
                    <!-- 태그 -->
                    {% if video.tags %}
                    <div style="margin-bottom: 15px;">
                        {% for tag in video.tags.split(',')[:3] %}
                        <span style="display: inline-block; background: #f0f9ff; color: #3a7ca5; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin: 2px 4px 2px 0;">
                            #{{ tag.strip() }}
                        </span>
                        {% endfor %}
                        {% if video.tags.split(',')|length > 3 %}
                        <span style="color: #999; font-size: 0.8em;">+{{ video.tags.split(',')|length - 3 }}개</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- 액션 버튼 -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <!-- 조회수 -->
                            <span style="color: #999; font-size: 0.9em;">
                                👁️ {{ video.view_count or 0 }}회
                            </span>
                            
                            <!-- 좋아요 -->
                            <span style="color: #999; font-size: 0.9em; cursor: pointer;" onclick="likeVideo({{ video.id }}, event)">
                                ❤️ <span id="like-count-{{ video.id }}">{{ video.like_count or 0 }}</span>
                            </span>
                            
                            <!-- 외부 링크 -->
                            {% if video.platform in ['youtube', 'vimeo'] %}
                            <a href="{{ video.external_url }}" target="_blank" 
                               style="color: #8b7355; text-decoration: none; font-size: 0.9em;"
                               onclick="event.stopPropagation();">
                                🔗 원본 보기
                            </a>
                            {% endif %}
                        </div>
                        
                        <!-- 관리자 액션 버튼 -->
                        {% if is_admin %}
                        <div style="display: flex; gap: 8px;">
                            <a href="/edit_video/{{ video.id }}" 
                               style="color: #8b7355; text-decoration: none; padding: 6px 12px; border: 1px solid #8b7355; border-radius: 15px; font-size: 0.8em; transition: all 0.3s ease;"
                               onclick="event.stopPropagation()"
                               onmouseover="this.style.background='#8b7355'; this.style.color='white'"
                               onmouseout="this.style.background='transparent'; this.style.color='#8b7355'">
                                수정
                            </a>
                            <button onclick="deleteVideo({{ video.id }}, event)" 
                                    style="color: #dc3545; background: transparent; border: 1px solid #dc3545; padding: 6px 12px; border-radius: 15px; font-size: 0.8em; cursor: pointer; transition: all 0.3s ease;"
                                    onmouseover="this.style.background='#dc3545'; this.style.color='white'"
                                    onmouseout="this.style.background='transparent'; this.style.color='#dc3545'">
                                삭제
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- 페이지네이션 -->
        {% if pagination and pagination.pages > 1 %}
        <div style="text-align: center; margin-top: 40px;">
            <div style="display: inline-flex; gap: 10px; align-items: center;">
                {% if pagination.has_prev %}
                <a href="{{ url_for('portfolio', page=pagination.prev_num, **request.args) }}" 
                   style="padding: 8px 16px; background: #f8f9fa; color: #8b7355; text-decoration: none; border-radius: 20px; transition: all 0.3s ease;"
                   onmouseover="this.style.background='#8b7355'; this.style.color='white'"
                   onmouseout="this.style.background='#f8f9fa'; this.style.color='#8b7355'">
                    이전
                </a>
                {% endif %}
                
                {% for page_num in pagination.iter_pages() %}
                    {% if page_num %}
                        {% if page_num != pagination.page %}
                        <a href="{{ url_for('portfolio', page=page_num, **request.args) }}" 
                           style="padding: 8px 12px; background: #f8f9fa; color: #666; text-decoration: none; border-radius: 20px; transition: all 0.3s ease;"
                           onmouseover="this.style.background='#e9ecef'"
                           onmouseout="this.style.background='#f8f9fa'">
                            {{ page_num }}
                        </a>
                        {% else %}
                        <span style="padding: 8px 12px; background: #8b7355; color: white; border-radius: 20px;">
                            {{ page_num }}
                        </span>
                        {% endif %}
                    {% else %}
                        <span style="padding: 8px 12px;">...</span>
                    {% endif %}
                {% endfor %}
                
                {% if pagination.has_next %}
                <a href="{{ url_for('portfolio', page=pagination.next_num, **request.args) }}" 
                   style="padding: 8px 16px; background: #f8f9fa; color: #8b7355; text-decoration: none; border-radius: 20px; transition: all 0.3s ease;"
                   onmouseover="this.style.background='#8b7355'; this.style.color='white'"
                   onmouseout="this.style.background='#f8f9fa'; this.style.color='#8b7355'">
                    다음
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
    {% else %}
        <!-- 영상이 없는 경우 -->
        <div style="text-align: center; padding: 80px 20px; background: #f8f9fa; border-radius: 12px; border: 2px dashed #ddd;">
            <div style="font-size: 3em; margin-bottom: 20px; opacity: 0.5;">🎬</div>
            {% if request.args.get('search') or request.args.get('platform') %}
                <h3 style="color: #666; margin: 0 0 15px 0; font-weight: 300;">검색 결과가 없습니다</h3>
                <p style="color: #999; margin: 0 0 25px 0;">다른 검색어나 필터를 시도해보세요</p>
                <a href="/portfolio" 
                   style="display: inline-block; background-color: #8b7355; color: white; padding: 12px 24px; text-decoration: none; border-radius: 25px; font-weight: 400;">
                    전체 영상 보기
                </a>
            {% else %}
                <h3 style="color: #666; margin: 0 0 15px 0; font-weight: 300;">아직 영상이 없습니다</h3>
                <p style="color: #999; margin: 0 0 25px 0;">첫 번째 영상을 추가해보세요!</p>
                {% if is_admin %}
                <a href="/add_video" 
                   style="display: inline-block; background-color: #8b7355; color: white; padding: 12px 24px; text-decoration: none; border-radius: 25px; font-weight: 400;">
                    영상 추가
                </a>
                {% endif %}
            {% endif %}
        </div>
    {% endif %}

</section>

<!-- 영상 모달 -->
<div id="videoModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; padding: 20px; box-sizing: border-box;">
    <div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
        <button onclick="closeVideoModal()" 
                style="position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.5); border: none; color: white; font-size: 2em; cursor: pointer; z-index: 1001; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
            ✕
        </button>
        <div id="modalContent" style="max-width: 90%; max-height: 90%; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
            <!-- 동적으로 iframe 또는 video 태그가 삽입됩니다 -->
        </div>
    </div>
</div>

<style>
/* 반응형 디자인 */
@media (max-width: 768px) {
    section {
        padding: 20px 15px !important;
    }
    
    .video-grid {
        grid-template-columns: 1fr !important;
    }
    
    .video-card {
        margin-bottom: 20px;
    }
    
    .search-form {
        flex-direction: column !important;
        align-items: stretch !important;
    }
    
    .search-form > div {
        margin-bottom: 10px;
    }
    
    .search-form button {
        width: 100% !important;
    }
}

@media (max-width: 480px) {
    h1 {
        font-size: 1.8em !important;
    }
    
    .video-card > div:last-child {
        padding: 15px !important;
    }
    
    .video-card .video-thumbnail {
        height: 200px !important;
    }
    
    .pagination {
        flex-wrap: wrap !important;
        gap: 5px !important;
    }
}

/* 호버 효과 개선 */
.video-card:hover .video-thumbnail img {
    transform: scale(1.05);
    transition: transform 0.3s ease;
}

/* 로딩 애니메이션 */
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.loading {
    animation: pulse 1.5s infinite;
}
</style>

<script>
// 영상 모달 열기
function openVideoModal(videoId) {
    fetch(`/api/video/${videoId}`)
        .then(response => response.json())
        .then(video => {
            const modal = document.getElementById('videoModal');
            const content = document.getElementById('modalContent');
            
            let videoElement = '';
            
            if (video.platform === 'youtube') {
                videoElement = `
                    <iframe width="100%" height="100%" 
                            src="https://www.youtube.com/embed/${video.video_id}?autoplay=1&rel=0" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen
                            style="max-width: 1200px; max-height: 675px; aspect-ratio: 16/9;">
                    </iframe>`;
            } else if (video.platform === 'vimeo') {
                videoElement = `
                    <iframe width="100%" height="100%" 
                            src="https://player.vimeo.com/video/${video.video_id}?autoplay=1" 
                            frameborder="0" 
                            allow="autoplay; fullscreen; picture-in-picture" 
                            allowfullscreen
                            style="max-width: 1200px; max-height: 675px; aspect-ratio: 16/9;">
                    </iframe>`;
            } else {
                // 로컬 파일
                videoElement = `
                    <video controls autoplay 
                           style="max-width: 100%; max-height: 100%; object-fit: contain;">
                        <source src="${video.video_url}" type="video/mp4">
                        브라우저가 비디오를 지원하지 않습니다.
                    </video>`;
            }
            
            content.innerHTML = videoElement;
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // 조회수 증가
            updateViewCount(videoId);
        })
        .catch(error => {
            console.error('Error loading video:', error);
            alert('영상을 불러올 수 없습니다.');
        });
}

// 영상 모달 닫기
function closeVideoModal() {
    const modal = document.getElementById('videoModal');
    const content = document.getElementById('modalContent');
    modal.style.display = 'none';
    content.innerHTML = '';
    document.body.style.overflow = 'auto';
}

// 좋아요 기능
function likeVideo(videoId, event) {
    event.stopPropagation();
    
    fetch(`/api/video/${videoId}/like`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    }).then(response => response.json())
      .then(data => {
          if (data.success) {
              const likeCountElement = document.getElementById(`like-count-${videoId}`);
              likeCountElement.textContent = data.like_count;
              
              // 좋아요 애니메이션
              likeCountElement.style.transform = 'scale(1.2)';
              likeCountElement.style.color = '#ff6b6b';
              
              setTimeout(() => {
                  likeCountElement.style.transform = 'scale(1)';
                  likeCountElement.style.color = '#999';
              }, 300);
          }
      }).catch(error => {
          console.error('Error:', error);
      });
}

// 조회수 업데이트
function updateViewCount(videoId) {
    fetch(`/api/video/${videoId}/view`, {
        method: 'POST'
    }).catch(error => console.error('View count update failed:', error));
}

// 영상 삭제
function deleteVideo(videoId, event) {
    event.stopPropagation();
    
    if (confirm('정말로 이 영상을 삭제하시겠습니까?')) {
        fetch(`/api/video/${videoId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        }).then(response => response.json())
          .then(data => {
              if (data.success) {
                  location.reload();
              } else {
                  alert('영상 삭제 중 오류가 발생했습니다.');
              }
          }).catch(error => {
              console.error('Error:', error);
              alert('영상 삭제 중 오류가 발생했습니다.');
          });
    }
}

// ESC 키로 모달 닫기
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeVideoModal();
    }
});

// 페이지 로드 시 URL 파라미터 유지
document.addEventListener('DOMContentLoaded', function() {
    // 검색 폼 자동 제출 방지
    const searchForm = document.querySelector('form');
    if (searchForm) {
        searchForm.addEventListener('submit', function(e) {
            const searchInput = document.querySelector('input[name="search"]');
            if (searchInput && !searchInput.value.trim()) {
                searchInput.removeAttribute('name');
            }
        });
    }
});

// 무한 스크롤 (선택사항)
let isLoading = false;
function loadMoreVideos() {
    if (isLoading) return;
    
    const currentPage = {{ pagination.page if pagination else 1 }};
    const totalPages = {{ pagination.pages if pagination else 1 }};
    
    if (currentPage >= totalPages) return;
    
    isLoading = true;
    
    // 로딩 표시
    const loadingElement = document.createElement('div');
    loadingElement.className = 'loading';
    loadingElement.style.textAlign = 'center';
    loadingElement.style.padding = '20px';
    loadingElement.innerHTML = '더 많은 영상을 불러오는 중...';
    
    document.querySelector('section').appendChild(loadingElement);
    
    // AJAX로 다음 페이지 로드
    const nextPage = currentPage + 1;
    const url = new URL(window.location);
    url.searchParams.set('page', nextPage);
    
    fetch(url.toString())
        .then(response => response.text())
        .then(html => {
            // 새로운 비디오 카드들을 추출하여 추가
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newCards = doc.querySelectorAll('.video-card');
            
            const videoGrid = document.querySelector('.video-grid');
            newCards.forEach(card => {
                videoGrid.appendChild(card);
            });
            
            loadingElement.remove();
            isLoading = false;
        })
        .catch(error => {
            console.error('Error loading more videos:', error);
            loadingElement.remove();
            isLoading = false;
        });
}

// 스크롤 이벤트로 무한 스크롤 트리거
window.addEventListener('scroll', function() {
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 1000) {
        loadMoreVideos();
    }
});
</script>
<script>
// 강력한 YouTube 썸네일 fallback 시스템
function handleThumbnailError(img, videoId) {
    const fallbackSizes = [
        'maxresdefault',
        'hqdefault', 
        'mqdefault',
        'default'
    ];
    
    // 현재 시도하고 있는 크기 찾기
    let currentIndex = -1;
    for (let i = 0; i < fallbackSizes.length; i++) {
        if (img.src.includes(fallbackSizes[i])) {
            currentIndex = i;
            break;
        }
    }
    
    // 다음 크기로 시도
    if (currentIndex < fallbackSizes.length - 1) {
        const nextSize = fallbackSizes[currentIndex + 1];
        img.src = `https://img.youtube.com/vi/${videoId}/${nextSize}.jpg`;
        console.log(`썸네일 fallback: ${nextSize} 시도 중...`);
        return;
    }
    
    // 모든 썸네일 실패 시 YouTube API에서 정보 가져오기 시도
    if (currentIndex >= fallbackSizes.length - 1) {
        tryYouTubeOEmbed(img, videoId);
    }
}

// YouTube oEmbed API로 썸네일 가져오기
function tryYouTubeOEmbed(img, videoId) {
    const oEmbedUrl = `https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`;
    
    fetch(oEmbedUrl)
        .then(response => response.json())
        .then(data => {
            if (data.thumbnail_url) {
                img.src = data.thumbnail_url;
                console.log('oEmbed 썸네일 성공:', data.thumbnail_url);
            } else {
                createFallbackThumbnail(img, videoId, data.title || '');
            }
        })
        .catch(error => {
            console.log('oEmbed 실패, 기본 썸네일 생성');
            createFallbackThumbnail(img, videoId, '');
        });
}

// 기본 썸네일 생성
function createFallbackThumbnail(img, videoId, title) {
    const container = img.parentElement;
    container.innerHTML = `
        <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #ff0000, #cc0000); display: flex; align-items: center; justify-content: center; position: relative;">
            <div style="text-align: center; color: white; padding: 20px;">
                <div style="font-size: 2.5em; margin-bottom: 10px;">📺</div>
                <div style="font-size: 1em; font-weight: 500; line-height: 1.3;">
                    ${title ? title.substring(0, 30) + (title.length > 30 ? '...' : '') : 'YouTube 영상'}
                </div>
                <div style="font-size: 0.8em; margin-top: 10px; opacity: 0.8;">
                    ID: ${videoId}
                </div>
            </div>
            <!-- 플레이 버튼 -->
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.2); border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
                <span style="color: white; font-size: 1.5em; margin-left: 3px;">▶</span>
            </div>
        </div>
    `;
}

// 페이지 로드 시 모든 YouTube 썸네일 확인
document.addEventListener('DOMContentLoaded', function() {
    const youtubeImages = document.querySelectorAll('img[src*="youtube.com"]');
    
    youtubeImages.forEach(img => {
        // 이미지 로드 완료 체크
        if (img.complete) {
            // 이미 로드된 경우 크기 체크
            if (img.naturalWidth === 0 || img.naturalHeight === 0) {
                const videoId = extractVideoIdFromSrc(img.src);
                if (videoId) {
                    handleThumbnailError(img, videoId);
                }
            }
        }
        
        // 에러 이벤트 리스너 추가
        img.addEventListener('error', function() {
            const videoId = extractVideoIdFromSrc(this.src);
            if (videoId) {
                handleThumbnailError(this, videoId);
            }
        });
    });
});

// URL에서 YouTube 비디오 ID 추출
function extractVideoIdFromSrc(src) {
    const match = src.match(/\/vi\/([^\/]+)\//);
    return match ? match[1] : null;
}

// 썸네일 사전 검증 함수
async function validateYouTubeThumbnail(videoId) {
    const sizes = ['maxresdefault', 'hqdefault', 'mqdefault', 'default'];
    
    for (const size of sizes) {
        const url = `https://img.youtube.com/vi/${videoId}/${size}.jpg`;
        try {
            const response = await fetch(url, { method: 'HEAD' });
            if (response.ok) {
                return url;
            }
        } catch (error) {
            continue;
        }
    }
    
    return null; // 모든 썸네일 실패
}
</script>
{% if video.platform == 'youtube' %}
    <!-- 썸네일 대신 YouTube 스타일 카드 -->
    <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #ff0000, #cc0000); display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; color: white;">
        
        <!-- YouTube 로고 영역 -->
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 3em; margin-bottom: 10px;">📺</div>
            <div style="font-size: 1.2em; font-weight: bold; color: white;">YouTube</div>
        </div>
        
        <!-- 영상 제목 -->
        <div style="text-align: center; padding: 0 20px; flex: 1; display: flex; align-items: center;">
            <div style="font-size: 1.1em; font-weight: 500; line-height: 1.3; color: white;">
                {{ video.title[:50] }}{% if video.title|length > 50 %}...{% endif %}
            </div>
        </div>
        
        <!-- 플레이 버튼 -->
        <div style="position: absolute; bottom: 20px; right: 20px; background: rgba(255,255,255,0.3); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
            <span style="color: white; font-size: 1.3em; margin-left: 2px;">▶</span>
        </div>
        
        <!-- Video ID 표시 (디버그용) -->
        <div style="position: absolute; bottom: 5px; left: 5px; font-size: 0.7em; opacity: 0.7; color: white;">
            ID: {{ video.video_id }}
        </div>
    </div>
{% endif %}
{% endblock %}